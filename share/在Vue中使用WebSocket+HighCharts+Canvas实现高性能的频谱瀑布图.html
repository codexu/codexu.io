<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>在Vue中使用WebSocket+HighCharts+Canvas实现高性能的频谱瀑布图 | X-BUILD</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.859a2b70.css" as="style"><link rel="preload" href="/assets/js/app.d8e8e414.js" as="script"><link rel="preload" href="/assets/js/2.4f310d24.js" as="script"><link rel="preload" href="/assets/js/18.355857b0.js" as="script"><link rel="prefetch" href="/assets/js/10.192e02b0.js"><link rel="prefetch" href="/assets/js/11.f9214cfd.js"><link rel="prefetch" href="/assets/js/12.c2eedbbc.js"><link rel="prefetch" href="/assets/js/13.10abc902.js"><link rel="prefetch" href="/assets/js/14.7afa5dc9.js"><link rel="prefetch" href="/assets/js/15.e4a1cd52.js"><link rel="prefetch" href="/assets/js/16.9166d4b2.js"><link rel="prefetch" href="/assets/js/17.ebcc5ac1.js"><link rel="prefetch" href="/assets/js/19.88ddee67.js"><link rel="prefetch" href="/assets/js/20.c730628b.js"><link rel="prefetch" href="/assets/js/21.86fa485e.js"><link rel="prefetch" href="/assets/js/22.2e10ac92.js"><link rel="prefetch" href="/assets/js/23.82951de6.js"><link rel="prefetch" href="/assets/js/24.cead7a62.js"><link rel="prefetch" href="/assets/js/25.06d598ae.js"><link rel="prefetch" href="/assets/js/26.a479499d.js"><link rel="prefetch" href="/assets/js/27.8822658b.js"><link rel="prefetch" href="/assets/js/28.3a36513b.js"><link rel="prefetch" href="/assets/js/29.ea50a4c3.js"><link rel="prefetch" href="/assets/js/3.f0afd4d3.js"><link rel="prefetch" href="/assets/js/30.56dd4442.js"><link rel="prefetch" href="/assets/js/31.de1d0d27.js"><link rel="prefetch" href="/assets/js/32.f29f594a.js"><link rel="prefetch" href="/assets/js/33.cc2e9e3e.js"><link rel="prefetch" href="/assets/js/34.f62ff633.js"><link rel="prefetch" href="/assets/js/35.e03987af.js"><link rel="prefetch" href="/assets/js/36.6004732e.js"><link rel="prefetch" href="/assets/js/37.d5bf2c46.js"><link rel="prefetch" href="/assets/js/38.942321d9.js"><link rel="prefetch" href="/assets/js/39.6369d8b6.js"><link rel="prefetch" href="/assets/js/4.2ca7c99c.js"><link rel="prefetch" href="/assets/js/40.5b0472d7.js"><link rel="prefetch" href="/assets/js/41.0bbde06c.js"><link rel="prefetch" href="/assets/js/42.7a6b1c0a.js"><link rel="prefetch" href="/assets/js/5.612f1155.js"><link rel="prefetch" href="/assets/js/6.c66491f5.js"><link rel="prefetch" href="/assets/js/7.921dde6d.js"><link rel="prefetch" href="/assets/js/8.932fae18.js"><link rel="prefetch" href="/assets/js/9.284a29d4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.859a2b70.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">X-BUILD</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Get started</a></div><div class="nav-item"><a href="/concept.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="/utils/get_started_quickly.html" class="nav-link">Tools</a></div><div class="nav-item"><a href="/case/" class="nav-link">Cases</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/share/在Vue中使用WebSocket+HighCharts+Canvas实现高性能的频谱瀑布图.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/codexu/x-build" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Get started</a></div><div class="nav-item"><a href="/concept.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="/utils/get_started_quickly.html" class="nav-link">Tools</a></div><div class="nav-item"><a href="/case/" class="nav-link">Cases</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/share/在Vue中使用WebSocket+HighCharts+Canvas实现高性能的频谱瀑布图.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/codexu/x-build" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Get started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/" class="sidebar-link">Overview</a></li><li><a href="/cli.html" class="sidebar-link">CLI</a></li><li><a href="/quick_start.html" class="sidebar-link">Quick start</a></li><li><a href="/create_project.html" class="sidebar-link">Create project</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/concept.html" class="sidebar-link">Concept</a></li><li><a href="/configuration.html" class="sidebar-link">Configuration</a></li><li><a href="/StateManagement.html" class="sidebar-link">State Management</a></li><li><a href="/specification.html" class="sidebar-link">Specification</a></li><li><a href="/Testing.html" class="sidebar-link">Testing</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Tools</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/utils/get_started_quickly.html" class="sidebar-link">Get started quickly</a></li><li><a href="/utils/x-fullpage.html" class="sidebar-link">Fullpage</a></li><li><a href="/utils/x-load.html" class="sidebar-link">Load</a></li><li><a href="/utils/x-animate.html" class="sidebar-link">Animate</a></li><li><a href="/utils/x-touch.html" class="sidebar-link">Touch</a></li><li><a href="/utils/x-music.html" class="sidebar-link">Music</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="在vue中使用websocket-highcharts-canvas实现高性能的频谱瀑布图"><a href="#在vue中使用websocket-highcharts-canvas实现高性能的频谱瀑布图" aria-hidden="true" class="header-anchor">#</a> 在Vue中使用WebSocket+HighCharts+Canvas实现高性能的频谱瀑布图</h1> <p>废话不多说，先上成品图：</p> <p><img src="http://ww2.sinaimg.cn/large/006tNc79ly1g4x362nn9aj30w90ine66.jpg" alt="频谱图+瀑布图"></p> <p>再来个迷你动图：</p> <p><img src="http://ww3.sinaimg.cn/large/006tNc79ly1g4x7i67tsqg308c04v4qq.gif" alt="频谱图+瀑布图动图"></p> <p>可能很多同学不知道频谱图和瀑布图，其实我也不懂...但是咱们前端就是负责把数据按照规则显示出来就好（上方折线图为频谱图，下方那一坨为瀑布图）。</p> <h2 id="技术选型"><a href="#技术选型" aria-hidden="true" class="header-anchor">#</a> 技术选型</h2> <p>框架：Vue(这并不重要，反正我也不会多说这块)</p> <p>数据传输：WebSocket</p> <p>频谱图：HighCharts</p> <p>瀑布图：Canvas</p> <ul><li>为什么使用 WebSocket ？</li></ul> <p>因为需要服务器实时传输数据，要求达到30帧，每帧动画由 <strong>1024</strong> 个点组成，肯定要比 Ajax 轮询舒服的多，而且这个项目对于浏览器兼容没什么要求。</p> <ul><li>为什么使用 HighCharts 绘制频谱图?</li></ul> <p>做了个测试，HighCharts 与 ECharts，虽然说 canvas 的性能要比 svg 强，但同时渲染觉得 HighCharts 更加流畅（HighCharts 需要付费）。</p> <ul><li>瀑布图为什么使用 Canvas ？</li></ul> <p>虽然说用数据可视化图表库很方便，但是考虑到此项目苛刻的性能要求，使用类似瀑布图的只有大型热力图：</p> <p><img src="http://ww1.sinaimg.cn/large/006tNc79ly1g4x3kx4guhj30au08wt9i.jpg" alt="大型热力图"></p> <p>用热力图做，请放心，不会卡成 PPT，浏览器5秒后准时直接崩溃。</p> <h2 id="组件功能拆分"><a href="#组件功能拆分" aria-hidden="true" class="header-anchor">#</a> 组件功能拆分</h2> <p>整个组件拆分为三部分：</p> <ul><li><p>父组件：负责 WebSocket 与服务器实时通讯、处理二进制数据、控制渲染频率、控制开始和暂停、刷新组件。</p></li> <li><p>子组件 &gt; 频谱图(HighCharts)：提供 addData 方法，获取数据即渲染一帧，提供触发缩放事件，发送给父组件。</p></li> <li><p>子组件 &gt; 瀑布图(Canvas)：与频谱图一样提供 addData 方法，频谱图发生缩放事件后，对应其选取的位置进行缩放。</p></li></ul> <h2 id="父组件"><a href="#父组件" aria-hidden="true" class="header-anchor">#</a> 父组件</h2> <h3 id="websocket-链接服务器"><a href="#websocket-链接服务器" aria-hidden="true" class="header-anchor">#</a> WebSocket 链接服务器</h3> <p>因为操作并不是很多，直接使用原生方式：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://192.168.2.250:8100/socket'</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
</code></pre></div><p>与后端对接好发送的指令，这里我们定义了三个：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 开始获取数据</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token comment">// 暂停获取数据</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'pause'</span><span class="token punctuation">)</span>
<span class="token comment">// 恢复获取数据</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'resume'</span><span class="token punctuation">)</span>
</code></pre></div><p>监听 onmessage 事件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>readyState <span class="token operator">===</span> FileReader<span class="token punctuation">.</span><span class="token constant">DONE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理二进制数据</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="处理二进制数据"><a href="#处理二进制数据" aria-hidden="true" class="header-anchor">#</a> 处理二进制数据</h3> <p>这块本来想用大篇幅来写，但是前几天看到<a href="https://juejin.im/post/5d1ea7a8e51d454fd8057bea" target="_blank" rel="noopener noreferrer">《为什么视频网站的视频链接地址是blob？》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，写的很好，自愧不如，请大家转移看懂这块，别忘了再回来。</p> <h3 id="控制渲染频率"><a href="#控制渲染频率" aria-hidden="true" class="header-anchor">#</a> 控制渲染频率</h3> <p>服务器这边大概一秒钟发送过来 400 条左右的数据，每秒400帧肯定是不现实了，直接导致丢帧。</p> <p>解决办法：建立数组保存数据，每次渲染一帧则删掉此条数据，当少于100条时发送 resume 继续获取，当超过400条时 发送 pause 暂停获取。</p> <p>以服务器这边的发送频率来说，会使 cpu 使用率超过100%，获取时会出现一点点卡顿，不过还能接受，毕竟获取一次可以渲染好几秒钟。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>renderInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">100</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketPause <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'resume'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socketPause <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">400</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketPause <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'pause'</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socketPause <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>frequency<span class="token punctuation">.</span><span class="token function">addData</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>waterFall<span class="token punctuation">.</span><span class="token function">addData</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>refreshInterval<span class="token punctuation">)</span>
</code></pre></div><p>使用 setInterval 定时渲染还有个好处就是可以控制渲染频率，注意组件右上角的拖动条，这样可以在低配电脑上降低渲染频率。</p> <h2 id="频谱图"><a href="#频谱图" aria-hidden="true" class="header-anchor">#</a> 频谱图</h2> <p>HighCharts 与 ECharts 配置项上有些差异，不过都是配置的问题，看看文档，很简单，记得关闭所有动画。</p> <h3 id="adddata"><a href="#adddata" aria-hidden="true" class="header-anchor">#</a> addData()</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span>series<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><p>父组件可以通过 $ref.addData() 触发渲染一帧</p> <h3 id="缩放"><a href="#缩放" aria-hidden="true" class="header-anchor">#</a> 缩放</h3> <p>在配置中 chart.zoomType 设置为 'x'，设置为 X 轴选择缩放。</p> <p>chart.events.selection 配置选择事件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">selection</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pointWidth <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>xAxisMax <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xAxisMin<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span>
  <span class="token keyword">const</span> ponitStart <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>xAxis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>min <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xAxisMin<span class="token punctuation">)</span> <span class="token operator">/</span> pointWidth<span class="token punctuation">)</span>
  <span class="token keyword">const</span> ponitEnd <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>xAxis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>max <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>xAxisMin<span class="token punctuation">)</span> <span class="token operator">/</span> pointWidth<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'frequencySelect'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ponitStart<span class="token punctuation">,</span> ponitEnd<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>向父组件发送已选取的点，再通过父组件传递给瀑布图组件。</p> <h2 id="瀑布图"><a href="#瀑布图" aria-hidden="true" class="header-anchor">#</a> 瀑布图</h2> <p>这里因为性能原因脱离了某些库，很多小伙伴到这里就不知该如何去做了，这里是本篇文章的重点。</p> <p>先了解几个概念，很多人接触过 Canvas，但是这几个估计没怎么注意过（像素操作）：</p> <ul><li>createImageData()</li> <li>putImageData()</li> <li>drawImage() 这个应该都知道</li></ul> <p>先创建两个画布，一个用于显示整体效果（this.canvas），另一个保存已生成的图像（this.waterFallDom，不会插入在 dom 上）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>waterFallDom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>waterFallCtx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waterFallDom<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="createimagedata"><a href="#createimagedata" aria-hidden="true" class="header-anchor">#</a> createImageData</h3> <p>createImageData(width,height) 方法创建新的空白 ImageData 对象，两个参数，设置图像宽高，这里项目需求一共 1024 个点：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> imageData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waterFallCtx<span class="token punctuation">.</span><span class="token function">createImageData</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>这时生成了一张 1024 * 1 的空白图像，我们继续要对每一个像素点进行操作上色：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imageData<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cindex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">squeeze</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> color <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>colormap<span class="token punctuation">[</span>cindex<span class="token punctuation">]</span>
  imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
  imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
  imageData<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span>
<span class="token punctuation">}</span>
<span class="token keyword">return</span> imageData
</code></pre></div><p>imageData.data 是一个数组，每四个值绘制一个像素点，分别对应：</p> <ul><li>R - 红色 (0-255)</li> <li>G - 绿色 (0-255)</li> <li>B - 蓝色 (0-255)</li> <li>A - alpha 通道 (0-255; 0 是透明的，255 是完全可见的)</li></ul> <p><strong>this.squeeze</strong>是根据数据计算出 colormap 中对应的点，这个不多说：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">squeeze</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> outMin<span class="token punctuation">,</span> outMax</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minDb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> outMin
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&gt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxDb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> outMax
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minDb<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxDb <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>minDb<span class="token punctuation">)</span> <span class="token operator">*</span> outMax<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>colormap</strong> 是一个二维数组，每个值代表[r, g, b, a]，这里我生成了150个颜色，是个渐变色，可以看下图例。</p> <ul><li>如何生成 colormap ？</li></ul> <p>如果你打算手写也没什么问题，就是手疼点。这里推荐使用 npm 安装 <a href="https://www.npmjs.com/package/colormap" target="_blank" rel="noopener noreferrer">colormap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>colormap <span class="token operator">=</span> <span class="token function">colormap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  colormap<span class="token punctuation">:</span> <span class="token string">'jet'</span><span class="token punctuation">,</span>
  nshades<span class="token punctuation">:</span> <span class="token number">150</span><span class="token punctuation">,</span>
  format<span class="token punctuation">:</span> <span class="token string">'rba'</span><span class="token punctuation">,</span>
  alpha<span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>提供了多种配色，具体请参考文档。</p> <p>到此，我们就生成了一张 具有颜色 1024 * 1 的图像，当然它还是个图像对象。</p> <h3 id="putimagedata"><a href="#putimagedata" aria-hidden="true" class="header-anchor">#</a> putImageData</h3> <p>putImageData(imgData,x,y,dirtyX,dirtyY,dirtyWidth,dirtyHeight) 将图像数据绘制到画布上：</p> <ul><li>imgData: 规定要放回画布的 ImageData 对象。</li> <li>x: ImageData 对象左上角的 x 坐标，以像素计。</li> <li>y: ImageData 对象左上角的 y 坐标，以像素计。</li> <li>dirtyX: 可选。水平值（x），以像素计，在画布上放置图像的位置。</li> <li>dirtyY: 可选。水平值（y），以像素计，在画布上放置图像的位置。</li> <li>dirtyWidth: 可选。在画布上绘制图像所使用的宽度。</li> <li>dirtyHeight: 可选。在画布上绘制图像所使用的高度。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>waterFallCtx<span class="token punctuation">.</span><span class="token function">putImageData</span><span class="token punctuation">(</span>imageData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="drawimage"><a href="#drawimage" aria-hidden="true" class="header-anchor">#</a> drawImage</h3> <p>这个大家比较熟悉，就是把图像绘制在画布中，这时我们就可以把 this.waterFallCtx 绘制到 this.ctx 上了。</p> <p>drawImage(img,sx,sy,swidth,sheight,x,y,width,height);</p> <ul><li>img: 规定要使用的图像、画布或视频。</li> <li>sx: 可选。开始剪切的 x 坐标位置。</li> <li>sy: 可选。开始剪切的 y 坐标位置。</li> <li>swidth: 可选。被剪切图像的宽度。</li> <li>sheight: 可选。被剪切图像的高度。</li> <li>x: 在画布上放置图像的 x 坐标位置。</li> <li>y: 在画布上放置图像的 y 坐标位置。</li> <li>width: 可选。要使用的图像的宽度。（伸展或缩小图像）</li> <li>height: 可选。要使用的图像的高度。（伸展或缩小图像）</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>waterFallCtx<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>
</code></pre></div><p>这里 sx、sy 可以配合频谱图做缩放的操作。</p> <p>width、height 可以被伸缩或缩小，显示效果比较不错，比如只有两个像素点的图像，被拉伸到 1000 个像素时并不是两个颜色一人一半，而是一条完美的渐变。</p> <h3 id="现实动态的瀑布图"><a href="#现实动态的瀑布图" aria-hidden="true" class="header-anchor">#</a> 现实动态的瀑布图</h3> <p>上述我们已经把第一行图像绘制到画布中，此时我们可能通过 WebSockt 已经拿到了几百条数据，每新增一行图像，前一行图像就要下一一行：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 将已生成的图像向下移动一个像素</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>waterFallCtx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>waterFallCtx<span class="token punctuation">.</span>canvas<span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">300</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">300</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>300 是指一共保存 300 行图像，这些数据都不应该是固定的，应该提前设置好，这里为了方便演示。</p> <p>通过调用自身的图像，并重新绘制到自己向下偏移 y 轴 1 像素，高度 -1 的图像。</p> <p>这样我们每添加一条数据，就会多一行新图像在最上方，已生成的图像向下移动了一个像素，自此我们的图像就动起来了。</p> <h3 id="实现缩放"><a href="#实现缩放" aria-hidden="true" class="header-anchor">#</a> 实现缩放</h3> <p>频谱图已经做好缩放操作，并把起始点和结束点传递给父组件，再有父组件传递给瀑布图组件，动态修改 drawImage 的剪切属性。</p> <h2 id="结语"><a href="#结语" aria-hidden="true" class="header-anchor">#</a> 结语</h2> <p>既然是使用 Vue 做的这个项目，我打算抽空做成 Vue 插件，做更多的可配置项。</p> <p>我曾一度觉得这是个不能能完成的项目，是自己太年轻了，公司的大佬提点了几句，就做出来了，在这里分享给大家，不论多难的项目总会有解决的办法。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/codexu/codexu.github.io/edit/docs/docs/share/在Vue中使用WebSocket+HighCharts+Canvas实现高性能的频谱瀑布图.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d8e8e414.js" defer></script><script src="/assets/js/2.4f310d24.js" defer></script><script src="/assets/js/18.355857b0.js" defer></script>
  </body>
</html>
